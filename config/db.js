const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const dbPath = path.resolve(__dirname, '../eduflow.db');

const db = new sqlite3.Database(dbPath, (err) => {
    if (err) console.error(err.message);
    else console.log('Connected to SQLite database.');
});

const createUserTable = `CREATE TABLE IF NOT EXISTS USER (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    FULL_NAME TEXT NOT NULL,
    EMAIL TEXT UNIQUE NOT NULL,
    PASSWORD_HASH TEXT NOT NULL,
    ROLE TEXT CHECK(ROLE IN ('student', 'faculty', 'admin')) NOT NULL,
    IS_APPROVED INTEGER DEFAULT 0,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP
)`;

const createCoursesTable = `CREATE TABLE IF NOT EXISTS COURSES (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    TITLE TEXT NOT NULL,
    CODE TEXT UNIQUE NOT NULL,
    INSTRUCTOR_ID INTEGER,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (INSTRUCTOR_ID) REFERENCES USER(ID)
)`;

const createEnrollmentTable = `CREATE TABLE IF NOT EXISTS ENROLLMENT (
    STUDENT_ID INTEGER,
    COURSE_ID INTEGER,
    PRIMARY KEY (STUDENT_ID, COURSE_ID),
    FOREIGN KEY (STUDENT_ID) REFERENCES USER(ID),
    FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
)`;

// âœ… MODIFIED: Added TITLE column
const createSubmissionTable = `CREATE TABLE IF NOT EXISTS SUBMISSION (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    ASSIGNMENT_ID INTEGER,
    STUDENT_ID INTEGER,
    TITLE TEXT, 
    FILE_PATH TEXT NOT NULL,
    FILE_TYPE TEXT,
    GRADE REAL DEFAULT NULL,
    FEEDBACK TEXT DEFAULT NULL,
    SUBMITTED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (STUDENT_ID) REFERENCES USER(ID)
)`;

const createNotificationTable = `CREATE TABLE IF NOT EXISTS NOTIFICATION (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    USER_ID INTEGER,
    MESSAGE TEXT NOT NULL,
    IS_READ INTEGER DEFAULT 0,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (USER_ID) REFERENCES USER(ID)
)`;

const createAnnouncementTable = `CREATE TABLE IF NOT EXISTS ANNOUNCEMENT (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    COURSE_ID INTEGER,
    TITLE TEXT NOT NULL,
    CONTENT TEXT NOT NULL,
    CREATED_AT DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
)`;

const createScheduleTable = `CREATE TABLE IF NOT EXISTS SCHEDULE (
    ID INTEGER PRIMARY KEY AUTOINCREMENT,
    COURSE_ID INTEGER,
    DAY TEXT NOT NULL,
    TYPE TEXT NOT NULL,
    TIME TEXT NOT NULL,
    LOCATION TEXT,
    FOREIGN KEY (COURSE_ID) REFERENCES COURSES(ID)
)`;

module.exports = {
    db,
    createUserTable,
    createCoursesTable,
    createEnrollmentTable,
    createSubmissionTable,
    createNotificationTable,
    createAnnouncementTable,
    createScheduleTable
};